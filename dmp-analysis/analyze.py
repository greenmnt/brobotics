#!/usr/bin/env python3
"""Analyze the MPU6050 DMP firmware blob to identify instruction patterns."""

import struct
from collections import Counter

# The 1929-byte DMP firmware blob
FW = bytes([
    # bank 0
    0xFB,0x00,0x00,0x3E,0x00,0x0B,0x00,0x36,0x00,0x01,0x00,0x02,0x00,0x03,0x00,0x00,
    0x00,0x65,0x00,0x54,0xFF,0xEF,0x00,0x00,0xFA,0x80,0x00,0x0B,0x12,0x82,0x00,0x01,
    0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x28,0x00,0x00,0xFF,0xFF,0x45,0x81,0xFF,0xFF,0xFA,0x72,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0xE8,0x00,0x00,0x00,0x01,0x00,0x01,0x7F,0xFF,0xFF,0xFE,0x80,0x01,
    0x00,0x1B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x40,0x00,0x00,0x40,0x00,0x00,0x00,0x02,0xCB,0x47,0xA2,0x20,0x00,0x00,0x00,
    0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x60,0x00,0x00,0x00,
    0x41,0xFF,0x00,0x00,0x00,0x00,0x0B,0x2A,0x00,0x00,0x16,0x55,0x00,0x00,0x21,0x82,
    0xFD,0x87,0x26,0x50,0xFD,0x80,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x05,0x80,0x00,
    0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x03,0x00,0x00,
    0x40,0x00,0x00,0x00,0x00,0x00,0x04,0x6F,0x00,0x02,0x65,0x32,0x00,0x00,0x5E,0xC0,
    0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFB,0x8C,0x6F,0x5D,0xFD,0x5D,0x08,0xD9,0x00,0x7C,0x73,0x3B,0x00,0x6C,0x12,0xCC,
    0x32,0x00,0x13,0x9D,0x32,0x00,0xD0,0xD6,0x32,0x00,0x08,0x00,0x40,0x00,0x01,0xF4,
    0xFF,0xE6,0x80,0x79,0x02,0x00,0x00,0x00,0x00,0x00,0xD0,0xD6,0x00,0x00,0x27,0x10,
    # bank 1
    0xFB,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,
    0x00,0x00,0xFA,0x36,0xFF,0xBC,0x30,0x8E,0x00,0x05,0xFB,0xF0,0xFF,0xD9,0x5B,0xC8,
    0xFF,0xD0,0x9A,0xBE,0x00,0x00,0x10,0xA9,0xFF,0xF4,0x1E,0xB2,0x00,0xCE,0xBB,0xF7,
    0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x04,0x00,0x02,0x00,0x02,0x02,0x00,0x00,0x0C,
    0xFF,0xC2,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0xCF,0x80,0x00,0x40,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x14,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x09,0x23,0xA1,0x35,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x03,0x3F,0x68,0xB6,0x79,0x35,0x28,0xBC,0xC6,0x7E,0xD1,0x6C,
    0x80,0x00,0xFF,0xFF,0x40,0x00,0x00,0x00,0x00,0x00,0xB2,0x6A,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xF0,0x00,0x00,0x00,0x30,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,
    0x00,0x00,0x25,0x4D,0x00,0x2F,0x70,0x6D,0x00,0x00,0x05,0xAE,0x00,0x0C,0x02,0xD0,
    # bank 2
    0x00,0x00,0x00,0x00,0x00,0x65,0x00,0x54,0xFF,0xEF,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x01,0x00,0x00,0x44,0x00,0x01,0x00,0x05,0x8B,0xC1,0x00,0x00,0x01,0x00,
    0x00,0x00,0x00,0x00,0x00,0x65,0x00,0x00,0x00,0x54,0x00,0x00,0xFF,0xEF,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x1B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x1B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    # bank 3
    0xD8,0xDC,0xBA,0xA2,0xF1,0xDE,0xB2,0xB8,0xB4,0xA8,0x81,0x91,0xF7,0x4A,0x90,0x7F,
    0x91,0x6A,0xF3,0xF9,0xDB,0xA8,0xF9,0xB0,0xBA,0xA0,0x80,0xF2,0xCE,0x81,0xF3,0xC2,
    0xF1,0xC1,0xF2,0xC3,0xF3,0xCC,0xA2,0xB2,0x80,0xF1,0xC6,0xD8,0x80,0xBA,0xA7,0xDF,
    0xDF,0xDF,0xF2,0xA7,0xC3,0xCB,0xC5,0xB6,0xF0,0x87,0xA2,0x94,0x24,0x48,0x70,0x3C,
    0x95,0x40,0x68,0x34,0x58,0x9B,0x78,0xA2,0xF1,0x83,0x92,0x2D,0x55,0x7D,0xD8,0xB1,
    0xB4,0xB8,0xA1,0xD0,0x91,0x80,0xF2,0x70,0xF3,0x70,0xF2,0x7C,0x80,0xA8,0xF1,0x01,
    0xB0,0x98,0x87,0xD9,0x43,0xD8,0x86,0xC9,0x88,0xBA,0xA1,0xF2,0x0E,0xB8,0x97,0x80,
    0xF1,0xA9,0xDF,0xDF,0xDF,0xAA,0xDF,0xDF,0xDF,0xF2,0xAA,0x4C,0xCD,0x6C,0xA9,0x0C,
    0xC9,0x2C,0x97,0x97,0x97,0x97,0xF1,0xA9,0x89,0x26,0x46,0x66,0xB0,0xB4,0xBA,0x80,
    0xAC,0xDE,0xF2,0xCA,0xF1,0xB2,0x8C,0x02,0xA9,0xB6,0x98,0x00,0x89,0x0E,0x16,0x1E,
    0xB8,0xA9,0xB4,0x99,0x2C,0x54,0x7C,0xB0,0x8A,0xA8,0x96,0x36,0x56,0x76,0xF1,0xB9,
    0xAF,0xB4,0xB0,0x83,0xC0,0xB8,0xA8,0x97,0x11,0xB1,0x8F,0x98,0xB9,0xAF,0xF0,0x24,
    0x08,0x44,0x10,0x64,0x18,0xF1,0xA3,0x29,0x55,0x7D,0xAF,0x83,0xB5,0x93,0xAF,0xF0,
    0x00,0x28,0x50,0xF1,0xA3,0x86,0x9F,0x61,0xA6,0xDA,0xDE,0xDF,0xD9,0xFA,0xA3,0x86,
    0x96,0xDB,0x31,0xA6,0xD9,0xF8,0xDF,0xBA,0xA6,0x8F,0xC2,0xC5,0xC7,0xB2,0x8C,0xC1,
    0xB8,0xA2,0xDF,0xDF,0xDF,0xA3,0xDF,0xDF,0xDF,0xD8,0xD8,0xF1,0xB8,0xA8,0xB2,0x86,
    # bank 4
    0xB4,0x98,0x0D,0x35,0x5D,0xB8,0xAA,0x98,0xB0,0x87,0x2D,0x35,0x3D,0xB2,0xB6,0xBA,
    0xAF,0x8C,0x96,0x19,0x8F,0x9F,0xA7,0x0E,0x16,0x1E,0xB4,0x9A,0xB8,0xAA,0x87,0x2C,
    0x54,0x7C,0xB9,0xA3,0xDE,0xDF,0xDF,0xA3,0xB1,0x80,0xF2,0xC4,0xCD,0xC9,0xF1,0xB8,
    0xA9,0xB4,0x99,0x83,0x0D,0x35,0x5D,0x89,0xB9,0xA3,0x2D,0x55,0x7D,0xB5,0x93,0xA3,
    0x0E,0x16,0x1E,0xA9,0x2C,0x54,0x7C,0xB8,0xB4,0xB0,0xF1,0x97,0x83,0xA8,0x11,0x84,
    0xA5,0x09,0x98,0xA3,0x83,0xF0,0xDA,0x24,0x08,0x44,0x10,0x64,0x18,0xD8,0xF1,0xA5,
    0x29,0x55,0x7D,0xA5,0x85,0x95,0x02,0x1A,0x2E,0x3A,0x56,0x5A,0x40,0x48,0xF9,0xF3,
    0xA3,0xD9,0xF8,0xF0,0x98,0x83,0x24,0x08,0x44,0x10,0x64,0x18,0x97,0x82,0xA8,0xF1,
    0x11,0xF0,0x98,0xA2,0x24,0x08,0x44,0x10,0x64,0x18,0xDA,0xF3,0xDE,0xD8,0x83,0xA5,
    0x94,0x01,0xD9,0xA3,0x02,0xF1,0xA2,0xC3,0xC5,0xC7,0xD8,0xF1,0x84,0x92,0xA2,0x4D,
    0xDA,0x2A,0xD8,0x48,0x69,0xD9,0x2A,0xD8,0x68,0x55,0xDA,0x32,0xD8,0x50,0x71,0xD9,
    0x32,0xD8,0x70,0x5D,0xDA,0x3A,0xD8,0x58,0x79,0xD9,0x3A,0xD8,0x78,0x93,0xA3,0x4D,
    0xDA,0x2A,0xD8,0x48,0x69,0xD9,0x2A,0xD8,0x68,0x55,0xDA,0x32,0xD8,0x50,0x71,0xD9,
    0x32,0xD8,0x70,0x5D,0xDA,0x3A,0xD8,0x58,0x79,0xD9,0x3A,0xD8,0x78,0xA8,0x8A,0x9A,
    0xF0,0x28,0x50,0x78,0x9E,0xF3,0x88,0x18,0xF1,0x9F,0x1D,0x98,0xA8,0xD9,0x08,0xD8,
    0xC8,0x9F,0x12,0x9E,0xF3,0x15,0xA8,0xDA,0x12,0x10,0xD8,0xF1,0xAF,0xC8,0x97,0x87,
    # bank 5
    0x34,0xB5,0xB9,0x94,0xA4,0x21,0xF3,0xD9,0x22,0xD8,0xF2,0x2D,0xF3,0xD9,0x2A,0xD8,
    0xF2,0x35,0xF3,0xD9,0x32,0xD8,0x81,0xA4,0x60,0x60,0x61,0xD9,0x61,0xD8,0x6C,0x68,
    0x69,0xD9,0x69,0xD8,0x74,0x70,0x71,0xD9,0x71,0xD8,0xB1,0xA3,0x84,0x19,0x3D,0x5D,
    0xA3,0x83,0x1A,0x3E,0x5E,0x93,0x10,0x30,0x81,0x10,0x11,0xB8,0xB0,0xAF,0x8F,0x94,
    0xF2,0xDA,0x3E,0xD8,0xB4,0x9A,0xA8,0x87,0x29,0xDA,0xF8,0xD8,0x87,0x9A,0x35,0xDA,
    0xF8,0xD8,0x87,0x9A,0x3D,0xDA,0xF8,0xD8,0xB1,0xB9,0xA4,0x98,0x85,0x02,0x2E,0x56,
    0xA5,0x81,0x00,0x0C,0x14,0xA3,0x97,0xB0,0x8A,0xF1,0x2D,0xD9,0x28,0xD8,0x4D,0xD9,
    0x48,0xD8,0x6D,0xD9,0x68,0xD8,0xB1,0x84,0x0D,0xDA,0x0E,0xD8,0xA3,0x29,0x83,0xDA,
    0x2C,0x0E,0xD8,0xA3,0x84,0x49,0x83,0xDA,0x2C,0x4C,0x0E,0xD8,0xB8,0xB0,0xA8,0x8A,
    0x9A,0xF5,0x20,0xAA,0xDA,0xDF,0xD8,0xA8,0x40,0xAA,0xD0,0xDA,0xDE,0xD8,0xA8,0x60,
    0xAA,0xDA,0xD0,0xDF,0xD8,0xF1,0x97,0x86,0xA8,0x31,0x9B,0x06,0x99,0x07,0xAB,0x97,
    0x28,0x88,0x9B,0xF0,0x0C,0x20,0x14,0x40,0xB8,0xB0,0xB4,0xA8,0x8C,0x9C,0xF0,0x04,
    0x28,0x51,0x79,0x1D,0x30,0x14,0x38,0xB2,0x82,0xAB,0xD0,0x98,0x2C,0x50,0x50,0x78,
    0x78,0x9B,0xF1,0x1A,0xB0,0xF0,0x8A,0x9C,0xA8,0x29,0x51,0x79,0x8B,0x29,0x51,0x79,
    0x8A,0x24,0x70,0x59,0x8B,0x20,0x58,0x71,0x8A,0x44,0x69,0x38,0x8B,0x39,0x40,0x68,
    0x8A,0x64,0x48,0x31,0x8B,0x30,0x49,0x60,0xA5,0x88,0x20,0x09,0x71,0x58,0x44,0x68,
    # bank 6
    0x11,0x39,0x64,0x49,0x30,0x19,0xF1,0xAC,0x00,0x2C,0x54,0x7C,0xF0,0x8C,0xA8,0x04,
    0x28,0x50,0x78,0xF1,0x88,0x97,0x26,0xA8,0x59,0x98,0xAC,0x8C,0x02,0x26,0x46,0x66,
    0xF0,0x89,0x9C,0xA8,0x29,0x51,0x79,0x24,0x70,0x59,0x44,0x69,0x38,0x64,0x48,0x31,
    0xA9,0x88,0x09,0x20,0x59,0x70,0xAB,0x11,0x38,0x40,0x69,0xA8,0x19,0x31,0x48,0x60,
    0x8C,0xA8,0x3C,0x41,0x5C,0x20,0x7C,0x00,0xF1,0x87,0x98,0x19,0x86,0xA8,0x6E,0x76,
    0x7E,0xA9,0x99,0x88,0x2D,0x55,0x7D,0x9E,0xB9,0xA3,0x8A,0x22,0x8A,0x6E,0x8A,0x56,
    0x8A,0x5E,0x9F,0xB1,0x83,0x06,0x26,0x46,0x66,0x0E,0x2E,0x4E,0x6E,0x9D,0xB8,0xAD,
    0x00,0x2C,0x54,0x7C,0xF2,0xB1,0x8C,0xB4,0x99,0xB9,0xA3,0x2D,0x55,0x7D,0x81,0x91,
    0xAC,0x38,0xAD,0x3A,0xB5,0x83,0x91,0xAC,0x2D,0xD9,0x28,0xD8,0x4D,0xD9,0x48,0xD8,
    0x6D,0xD9,0x68,0xD8,0x8C,0x9D,0xAE,0x29,0xD9,0x04,0xAE,0xD8,0x51,0xD9,0x04,0xAE,
    0xD8,0x79,0xD9,0x04,0xD8,0x81,0xF3,0x9D,0xAD,0x00,0x8D,0xAE,0x19,0x81,0xAD,0xD9,
    0x01,0xD8,0xF2,0xAE,0xDA,0x26,0xD8,0x8E,0x91,0x29,0x83,0xA7,0xD9,0xAD,0xAD,0xAD,
    0xAD,0xF3,0x2A,0xD8,0xD8,0xF1,0xB0,0xAC,0x89,0x91,0x3E,0x5E,0x76,0xF3,0xAC,0x2E,
    0x2E,0xF1,0xB1,0x8C,0x5A,0x9C,0xAC,0x2C,0x28,0x28,0x28,0x9C,0xAC,0x30,0x18,0xA8,
    0x98,0x81,0x28,0x34,0x3C,0x97,0x24,0xA7,0x28,0x34,0x3C,0x9C,0x24,0xF2,0xB0,0x89,
    0xAC,0x91,0x2C,0x4C,0x6C,0x8A,0x9B,0x2D,0xD9,0xD8,0xD8,0x51,0xD9,0xD8,0xD8,0x79,
    # bank 7
    0xD9,0xD8,0xD8,0xF1,0x9E,0x88,0xA3,0x31,0xDA,0xD8,0xD8,0x91,0x2D,0xD9,0x28,0xD8,
    0x4D,0xD9,0x48,0xD8,0x6D,0xD9,0x68,0xD8,0xB1,0x83,0x93,0x35,0x3D,0x80,0x25,0xDA,
    0xD8,0xD8,0x85,0x69,0xDA,0xD8,0xD8,0xB4,0x93,0x81,0xA3,0x28,0x34,0x3C,0xF3,0xAB,
    0x8B,0xF8,0xA3,0x91,0xB6,0x09,0xB4,0xD9,0xAB,0xDE,0xFA,0xB0,0x87,0x9C,0xB9,0xA3,
    0xDD,0xF1,0x20,0x28,0x30,0x38,0x9A,0xF1,0x28,0x30,0x38,0x9D,0xF1,0xA3,0xA3,0xA3,
    0xA3,0xF2,0xA3,0xB4,0x90,0x80,0xF2,0xA3,0xA3,0xA3,0xA3,0xA3,0xA3,0xA3,0xA3,0xA3,
    0xA3,0xB2,0xA3,0xA3,0xA3,0xA3,0xA3,0xA3,0xB0,0x87,0xB5,0x99,0xF1,0x28,0x30,0x38,
    0x98,0xF1,0xA3,0xA3,0xA3,0xA3,0x97,0xA3,0xA3,0xA3,0xA3,0xF3,0x9B,0xA3,0x30,0xDC,
    0xB9,0xA7,0xF1,0x26,0x26,0x26,0xFE,0xD8,0xFF,
])

assert len(FW) == 1929

print("=" * 70)
print("MPU6050 DMP FIRMWARE ANALYSIS")
print("=" * 70)

# 1. Region analysis
print("\n--- REGION ANALYSIS ---")
for bank in range(8):
    start = bank * 256
    end = min(start + 256, len(FW))
    chunk = FW[start:end]
    zeros = chunk.count(0)
    entropy_chars = len(set(chunk))
    print(f"Bank {bank} [0x{start:03X}-0x{end-1:03X}]: "
          f"{len(chunk):3d} bytes, {zeros:3d} zeros ({100*zeros//len(chunk):2d}%), "
          f"{entropy_chars:3d} unique bytes  "
          f"{'[DATA]' if zeros > 50 else '[CODE]'}")

# 2. Byte frequency in code region (banks 3-7)
print("\n--- BYTE FREQUENCY (Banks 3-7, code region) ---")
code = FW[0x300:]
freq = Counter(code)
top = freq.most_common(30)
for byte, count in top:
    bar = '#' * (count // 2)
    print(f"  0x{byte:02X} ({byte:3d}): {count:3d} {bar}")

# 3. Look for known constants in data region
print("\n--- KNOWN CONSTANTS (Banks 0-2) ---")
data = FW[:0x300]
for i in range(0, len(data) - 1):
    val16 = (data[i] << 8) | data[i+1]
    val32 = None
    if i < len(data) - 3:
        val32 = (data[i] << 24) | (data[i+1] << 16) | (data[i+2] << 8) | data[i+3]

    notes = []
    if val16 == 0x4000: notes.append("16384 = Q14 scale (quaternion normalization)")
    if val16 == 0x7FFF: notes.append("32767 = max int16")
    if val16 == 0x03E8: notes.append("1000 (sample rate divisor?)")
    if val16 == 0x2710: notes.append("10000")
    if val16 == 0x01F4: notes.append("500")
    if val16 == 0xD0D6: notes.append("-12074 or 53462")
    if val16 == 0x001B: notes.append("27 (gyro sensitivity?)")
    if val16 == 0x0065: notes.append("101")
    if val16 == 0x0054: notes.append("84")
    if val16 == 0x5EC0: notes.append("24256")
    if val16 == 0x046F: notes.append("1135")
    if val16 == 0x6532: notes.append("25906")
    if val32 and val32 == 0x3FF00000: notes.append("1.0 in IEEE754 double (high word)")
    if val32 and val32 == 0x40000000: notes.append("2.0 in IEEE754 float OR Q30 = 1.0")
    if val32 and val32 == 0x02CB47A2: notes.append("46925730 (mystery)")

    for note in notes:
        print(f"  [0x{i:03X}] 0x{val16:04X} = {note}")

# 4. Pattern analysis: D8/D9/DA sequences in code
print("\n--- D8/D9/DA PATTERN ANALYSIS ---")
code = FW[0x300:]
# Find all D9 xx D8 and DA xx D8 patterns
d9_d8_patterns = []
da_d8_patterns = []
for i in range(len(code) - 2):
    if code[i] == 0xD9 and code[i+2] == 0xD8:
        d9_d8_patterns.append(code[i+1])
    if code[i] == 0xDA and code[i+2] == 0xD8:
        da_d8_patterns.append(code[i+1])

print(f"D9 xx D8 patterns ({len(d9_d8_patterns)} occurrences):")
for val, cnt in Counter(d9_d8_patterns).most_common(15):
    print(f"  D9 {val:02X} D8 : {cnt}x")

print(f"\nDA xx D8 patterns ({len(da_d8_patterns)} occurrences):")
for val, cnt in Counter(da_d8_patterns).most_common(15):
    print(f"  DA {val:02X} D8 : {cnt}x")

# 5. F0/F1/F2/F3 prefix analysis
print("\n--- Fx PREFIX ANALYSIS ---")
for prefix in [0xF0, 0xF1, 0xF2, 0xF3, 0xF5, 0xF7, 0xF8, 0xF9, 0xFA, 0xFB]:
    positions = [i for i in range(len(code)) if code[i] == prefix]
    if positions:
        # Show what follows each prefix
        followers = []
        for pos in positions:
            if pos + 1 < len(code):
                followers.append(code[pos + 1])
        top_followers = Counter(followers).most_common(8)
        follower_str = ', '.join(f'0x{val:02X}({cnt})' for val, cnt in top_followers)
        print(f"0x{prefix:02X} appears {len(positions)}x, followed by: {follower_str}")

# 6. Triplet patterns (possible 3-byte instructions)
print("\n--- REPEATED TRIPLET PATTERNS (banks 3-7) ---")
triplets = Counter()
for i in range(len(code) - 2):
    triplet = (code[i], code[i+1], code[i+2])
    triplets[triplet] += 1
for (a, b, c), cnt in triplets.most_common(20):
    if cnt >= 2:
        print(f"  {a:02X} {b:02X} {c:02X} : {cnt}x")

# 7. Byte ranges analysis
print("\n--- BYTE RANGE CATEGORIES (banks 3-7) ---")
ranges = {
    "0x00-0x3F (small immediates)": 0,
    "0x40-0x7F (medium immediates)": 0,
    "0x80-0x9F (possible registers)": 0,
    "0xA0-0xBF (possible registers)": 0,
    "0xC0-0xDF (possible opcodes)": 0,
    "0xE0-0xFF (possible opcodes)": 0,
}
for b in code:
    if b <= 0x3F: ranges["0x00-0x3F (small immediates)"] += 1
    elif b <= 0x7F: ranges["0x40-0x7F (medium immediates)"] += 1
    elif b <= 0x9F: ranges["0x80-0x9F (possible registers)"] += 1
    elif b <= 0xBF: ranges["0xA0-0xBF (possible registers)"] += 1
    elif b <= 0xDF: ranges["0xC0-0xDF (possible opcodes)"] += 1
    else: ranges["0xE0-0xFF (possible opcodes)"] += 1
for name, cnt in ranges.items():
    pct = 100 * cnt // len(code)
    print(f"  {name}: {cnt:3d} ({pct:2d}%)")

# 8. Look for XYZ axis patterns (triplets of related operations)
print("\n--- XYZ AXIS PATTERNS (triplets with stride 0x28) ---")
print("Looking for sequences like: op X, op Y, op Z")
for i in range(len(code) - 8):
    a, b, c = code[i], code[i+1], code[i+2]
    # Check for patterns like: val, val+N, val+2N
    for stride in [0x08, 0x20, 0x28]:
        if (i + 5 < len(code) and
            code[i+2] == a + stride and code[i+3] == b and
            code[i+4] == a + 2*stride and code[i+5] == b):
            pass  # Would need more context

# 9. Sequence: 0x24 0x08 0x44 0x10 0x64 0x18 (appears multiple times)
print("\n--- RECURRING 6-BYTE SEQUENCE ---")
target = bytes([0x24, 0x08, 0x44, 0x10, 0x64, 0x18])
positions = []
for i in range(len(FW) - 5):
    if FW[i:i+6] == target:
        positions.append(i)
print(f"Sequence 24 08 44 10 64 18 appears {len(positions)} times at offsets:")
for p in positions:
    bank = p // 256
    offset = p % 256
    ctx_before = ' '.join(f'{FW[max(0,p-3)+j]:02X}' for j in range(min(3, p)))
    ctx_after = ' '.join(f'{FW[p+6+j]:02X}' for j in range(min(4, len(FW)-p-6)))
    print(f"  0x{p:03X} (bank {bank}, +0x{offset:02X}) ... {ctx_before} | 24 08 44 10 64 18 | {ctx_after}")

print("\nNote: 0x24=36, 0x44=68, 0x64=100 (stride=32)")
print("      0x08=8,  0x10=16, 0x18=24  (stride=8)")
print("Could be 3-axis register offsets for accel/gyro (X,Y,Z) with data format bytes")

# 10. Look for the quaternion cross-multiplication pattern
print("\n--- REPEATED BLOCK IN BANK 4 (quaternion cross-multiply?) ---")
block1 = FW[0x4A0:0x4B8]
block2 = FW[0x4B8:0x4D0]
if block1 == block2:
    print("Blocks 0x4A0-0x4B7 and 0x4B8-0x4CF are IDENTICAL:")
    print("  " + " ".join(f"{b:02X}" for b in block1))
    print("This repeated 24-byte block likely processes two quaternion components identically")
else:
    print("Blocks differ:")
    print("  Block1: " + " ".join(f"{b:02X}" for b in block1))
    print("  Block2: " + " ".join(f"{b:02X}" for b in block2))
    diffs = [(i, block1[i], block2[i]) for i in range(min(len(block1), len(block2))) if block1[i] != block2[i]]
    print(f"  Differences: {len(diffs)} bytes differ")
    for pos, a, b in diffs:
        print(f"    +{pos}: 0x{a:02X} -> 0x{b:02X}")
